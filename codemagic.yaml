workflows:
  unity-ios:
    name: Unity iOS Build
    environment:
      vars:
        UNITY_VERSION: "2020.3.25f1"  # correct
        XCODE_WORKSPACE: "Unity-iPhone.xcodeproj" #correct
        XCODE_SCHEME: "Unity-iPhone"
    triggering:
      events:
        - push
    scripts:
      - name: Set up Unity
        script: |
          echo "Setting up Unity..."
          wget https://beta.unity3d.com/download/8887702a2c7d/MacEditorTargetInstaller/UnitySetup-iOS-Support-for-Editor-2020.3.17f1.pkg
          sudo installer -pkg UnitySetup-iOS-Support-for-Editor-2020.3.17f1.pkg -target /
      - name: Install CocoaPods dependencies
        script: |
          cd $CM_BUILD_DIR/ios
          pod install
      - name: Build Xcode project
        script: |
          xcodebuild -workspace $XCODE_WORKSPACE -scheme $XCODE_SCHEME -sdk iphoneos -configuration Release archive -archivePath $HOME/output/Unity-iPhone.xcarchive
      - name: Export IPA
        script: |
          xcodebuild -exportArchive -archivePath $HOME/output/Unity-iPhone.xcarchive -exportPath $HOME/output -exportOptionsPlist $CM_BUILD_DIR/ios/exportOptions.plist
    artifacts:
      - $HOME/output/*.ipa
